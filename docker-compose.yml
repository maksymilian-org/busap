services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: busap-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: busap
      POSTGRES_PASSWORD: busap_secret
      POSTGRES_DB: busap
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U busap -d busap"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: busap-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Mailpit (dev email server)
  mailpit:
    image: axllent/mailpit
    container_name: busap-mailpit
    restart: unless-stopped
    ports:
      - "1025:1025"
      - "8025:8025"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8025/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # OpenRouteService (local routing engine)
  ors:
    image: openrouteservice/openrouteservice:v9.7.0
    container_name: busap-ors
    restart: unless-stopped
    ports:
      - "8082:8082"
    volumes:
      - ./docker/ors/files:/home/ors/files
      - ./docker/ors/ors-config.yml:/home/ors/config/ors-config.yml
      - ors_graphs:/home/ors/graphs
      - ors_elevation:/home/ors/elevation_cache
    environment:
      - XMS=512m
      - XMX=4g
      - REBUILD_GRAPHS=false
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8082/ors/v2/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  # NestJS API (for development with hot reload)
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: busap-api
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - ./apps/api:/app/apps/api
      - ./packages/shared:/app/packages/shared
      - /app/node_modules
      - /app/apps/api/node_modules
      - api_uploads:/app/apps/api/uploads
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://busap:busap_secret@postgres:5432/busap?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-busap_dev_jwt_secret_change_in_production}
      - JWT_ACCESS_EXPIRES_IN=15m
      - JWT_REFRESH_EXPIRES_IN=7d
      - UPLOAD_DIR=./uploads
      - MAX_FILE_SIZE=5242880
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-busap-storage}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-}
      - API_PORT=3001
      - API_HOST=0.0.0.0
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      - SMTP_USER=
      - SMTP_PASS=
      - SMTP_SECURE=false
      - MAIL_FROM=Busap <noreply@busap.pl>
      - FRONTEND_URL=http://localhost:3000
      - ORS_BASE_URL=http://ors:8082/ors
      - ORS_FALLBACK_URL=${ORS_FALLBACK_URL:-https://api.openrouteservice.org}
      - ORS_API_KEY=${ORS_API_KEY:-}
      - ORS_PROFILE=${ORS_PROFILE:-driving-hgv}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailpit:
        condition: service_healthy
      ors:
        condition: service_healthy
    command: pnpm --filter @busap/api dev

  # Next.js Web (for development with hot reload)
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: busap-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./apps/web:/app/apps/web
      - ./packages/shared:/app/packages/shared
      - /app/node_modules
      - /app/apps/web/node_modules
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:3001
    depends_on:
      - api
    command: pnpm --filter @busap/web dev

volumes:
  postgres_data:
  redis_data:
  api_uploads:
  ors_graphs:
  ors_elevation:
