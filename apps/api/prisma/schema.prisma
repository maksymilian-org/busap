generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Users & Companies ====================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  firstName         String    @map("first_name")
  lastName          String    @map("last_name")
  phone             String?
  avatarUrl         String?   @map("avatar_url")
  preferredLanguage String    @default("pl") @map("preferred_language")
  systemRole        String    @default("passenger") @map("system_role") // passenger, admin, superadmin
  emailVerified     Boolean   @default(false) @map("email_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at")
  lastLoginAt       DateTime? @map("last_login_at")
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  companyUsers    CompanyUser[]
  driverTrips     Trip[]         @relation("DriverTrips")
  auditLogs       AuditLog[]
  refreshTokens   RefreshToken[]
  invitations     Invitation[]
  authTokens      AuthToken[]
  driverSchedules TripSchedule[] @relation("ScheduleDriver")
  createdStops    Stop[]         @relation("StopCreator")
  createdRoutes   Route[]        @relation("RouteCreator")
  favoriteStopsAdded  CompanyFavoriteStop[]  @relation("FavoriteStopAdder")
  favoriteRoutesAdded CompanyFavoriteRoute[] @relation("FavoriteRouteAdder")
  createdNews         CompanyNews[]          @relation("NewsCreator")
  favoriteCompanies   UserFavoriteCompany[]
  favoriteRoutes      UserFavoriteRoute[]
  favoriteStops       UserFavoriteStop[]

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  family    String
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([family])
  @@map("refresh_tokens")
}

model AuthToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  type      String // email_verification, password_reset
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type, token])
  @@map("auth_tokens")
}

model Invitation {
  id          String    @id @default(uuid())
  email       String
  token       String    @unique
  role        String    @default("passenger") // role to assign upon registration
  companyId   String?   @map("company_id")
  companyRole String?   @map("company_role") // role within company
  invitedById String    @map("invited_by_id")
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  invitedBy User @relation(fields: [invitedById], references: [id])

  @@index([token])
  @@index([email])
  @@map("invitations")
}

model Company {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  logoUrl      String?  @map("logo_url")
  description  String?
  contactEmail String   @map("contact_email")
  contactPhone  String?  @map("contact_phone")
  contactPhone2 String?  @map("contact_phone_2")
  contactPhone3 String?  @map("contact_phone_3")
  address       String?
  website       String?
  facebookUrl   String?  @map("facebook_url")
  instagramUrl  String?  @map("instagram_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  companyUsers   CompanyUser[]
  stops          Stop[]
  routes         Route[]
  vehicles       Vehicle[]
  trips          Trip[]
  prices         Price[]
  auditLogs      AuditLog[]
  tripSchedules  TripSchedule[]
  calendars      Calendar[]
  favoriteStops  CompanyFavoriteStop[]
  favoriteRoutes CompanyFavoriteRoute[]
  news           CompanyNews[]
  favoritedByUsers UserFavoriteCompany[]

  @@map("companies")
}

model CompanyUser {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  companyId String   @map("company_id")
  role      String // passenger, driver, manager, owner, superadmin
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_users")
}

// ==================== Stops ====================

model Stop {
  id          String   @id @default(uuid())
  name        String
  code        String?
  latitude    Float
  longitude   Float
  address     String?
  city        String?
  country          String?
  county           String?  @map("county")
  region           String?  @map("region")
  postalCode       String?  @map("postal_code")
  countryCode      String?  @map("country_code")
  formattedAddress String?  @map("formatted_address")
  companyId   String?  @map("company_id")
  createdById String?  @map("created_by_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company          Company?              @relation(fields: [companyId], references: [id])
  createdBy        User?                 @relation("StopCreator", fields: [createdById], references: [id])
  routeStops       RouteStop[]
  companyFavorites CompanyFavoriteStop[]
  userFavorites    UserFavoriteStop[]

  @@index([companyId])
  @@index([latitude, longitude])
  @@map("stops")
}

// ==================== Routes ====================

model Route {
  id               String   @id @default(uuid())
  companyId        String   @map("company_id")
  name             String
  nameOverridden   Boolean  @default(false) @map("name_overridden")
  code             String?
  description      String?
  comment          String?  @map("comment")
  type             String   @default("linear") // linear, loop
  isActive         Boolean  @default(true) @map("is_active")
  currentVersionId String?  @unique @map("current_version_id")
  createdById      String?  @map("created_by_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  company          Company              @relation(fields: [companyId], references: [id])
  currentVersion   RouteVersion?        @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  createdBy        User?                @relation("RouteCreator", fields: [createdById], references: [id])
  versions         RouteVersion[]       @relation("RouteVersions")
  exceptions       RouteException[]
  trips            Trip[]
  prices           Price[]
  schedules        TripSchedule[]
  companyFavorites CompanyFavoriteRoute[]
  favoritedByUsers UserFavoriteRoute[]

  @@index([companyId])
  @@map("routes")
}

model RouteVersion {
  id            String    @id @default(uuid())
  routeId       String    @map("route_id")
  versionNumber Int       @map("version_number")
  validFrom     DateTime  @map("valid_from")
  validTo       DateTime? @map("valid_to")
  isActive      Boolean   @default(true) @map("is_active")
  geometry      Json?     @db.JsonB
  totalDistance  Float?    @map("total_distance")
  totalDuration Int?      @map("total_duration")
  waypoints     Json      @default("{}") @db.JsonB
  createdAt     DateTime  @default(now()) @map("created_at")

  route        Route       @relation("RouteVersions", fields: [routeId], references: [id], onDelete: Cascade)
  currentRoute Route?      @relation("CurrentVersion")
  stops        RouteStop[]
  trips        Trip[]

  @@unique([routeId, versionNumber])
  @@map("route_versions")
}

model RouteStop {
  id                String  @id @default(uuid())
  routeVersionId    String  @map("route_version_id")
  stopId            String  @map("stop_id")
  sequenceNumber    Int     @map("sequence_number")
  distanceFromStart Float   @default(0) @map("distance_from_start") // meters
  durationFromStart Int     @default(0) @map("duration_from_start") // minutes
  isPickup          Boolean @default(true) @map("is_pickup")
  isDropoff         Boolean @default(true) @map("is_dropoff")
  isMain            Boolean @default(false) @map("is_main")

  routeVersion       RouteVersion        @relation(fields: [routeVersionId], references: [id], onDelete: Cascade)
  stop               Stop                @relation(fields: [stopId], references: [id])
  stopTimes          TripStopTime[]
  scheduleStopTimes  ScheduleStopTime[]

  @@unique([routeVersionId, sequenceNumber])
  @@map("route_stops")
}

model RouteException {
  id                 String    @id @default(uuid())
  routeId            String    @map("route_id")
  type               String // temporary, permanent
  reason             String
  affectedStopIds    String[]  @map("affected_stop_ids")
  alternativeRouteId String?   @map("alternative_route_id")
  validFrom          DateTime  @map("valid_from")
  validTo            DateTime? @map("valid_to")
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@map("route_exceptions")
}

// ==================== Vehicles ====================

model Vehicle {
  id                 String   @id @default(uuid())
  companyId          String   @map("company_id")
  registrationNumber String   @map("registration_number")
  brand              String?
  model              String?
  capacity           Int
  photoUrl           String?  @map("photo_url")
  status             String   @default("active") // active, inactive, maintenance, out_of_service
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  company   Company           @relation(fields: [companyId], references: [id])
  trips     Trip[]
  positions VehiclePosition[]
  schedules TripSchedule[]

  @@unique([companyId, registrationNumber])
  @@map("vehicles")
}

model VehiclePosition {
  id        String   @id @default(uuid())
  vehicleId String   @map("vehicle_id")
  tripId    String?  @map("trip_id")
  latitude  Float
  longitude Float
  speed     Float? // km/h
  heading   Float? // degrees 0-360
  accuracy  Float? // meters
  timestamp DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  trip    Trip?   @relation(fields: [tripId], references: [id])

  @@index([vehicleId, timestamp])
  @@index([tripId])
  @@map("vehicle_positions")
}

// ==================== Trips ====================

model Trip {
  id                     String    @id @default(uuid())
  companyId              String    @map("company_id")
  routeId                String    @map("route_id")
  routeVersionId         String    @map("route_version_id")
  vehicleId              String?   @map("vehicle_id")
  driverId               String?   @map("driver_id")
  scheduleId             String?   @map("schedule_id")
  scheduleDate           DateTime? @map("schedule_date") @db.Date
  scheduledDepartureTime DateTime  @map("scheduled_departure_time")
  scheduledArrivalTime   DateTime  @map("scheduled_arrival_time")
  actualDepartureTime    DateTime? @map("actual_departure_time")
  actualArrivalTime      DateTime? @map("actual_arrival_time")
  status                 String    @default("scheduled") // scheduled, in_progress, completed, cancelled, delayed
  notes                  String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  company      Company           @relation(fields: [companyId], references: [id])
  route        Route             @relation(fields: [routeId], references: [id])
  routeVersion RouteVersion      @relation(fields: [routeVersionId], references: [id])
  vehicle      Vehicle?          @relation(fields: [vehicleId], references: [id])
  driver       User?             @relation("DriverTrips", fields: [driverId], references: [id])
  schedule     TripSchedule?     @relation(fields: [scheduleId], references: [id])
  stopTimes    TripStopTime[]
  positions    VehiclePosition[]

  @@unique([scheduleId, scheduleDate])
  @@index([companyId, scheduledDepartureTime])
  @@index([driverId, scheduledDepartureTime])
  @@index([scheduleId])
  @@index([status])
  @@map("trips")
}

model TripStopTime {
  id                 String    @id @default(uuid())
  tripId             String    @map("trip_id")
  routeStopId        String    @map("route_stop_id")
  scheduledArrival   DateTime  @map("scheduled_arrival")
  scheduledDeparture DateTime  @map("scheduled_departure")
  actualArrival      DateTime? @map("actual_arrival")
  actualDeparture    DateTime? @map("actual_departure")

  trip      Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  routeStop RouteStop @relation(fields: [routeStopId], references: [id])

  @@unique([tripId, routeStopId])
  @@map("trip_stop_times")
}

// ==================== Pricing ====================

model Price {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  routeId   String?   @map("route_id")
  type      String    @default("flat") // flat, per_segment
  basePrice Int       @map("base_price") // in cents/grosze
  currency  String    @default("PLN")
  isActive  Boolean   @default(true) @map("is_active")
  validFrom DateTime  @map("valid_from")
  validTo   DateTime? @map("valid_to")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  company  Company        @relation(fields: [companyId], references: [id])
  route    Route?         @relation(fields: [routeId], references: [id])
  segments SegmentPrice[]

  @@index([companyId, isActive])
  @@map("prices")
}

model SegmentPrice {
  id         String @id @default(uuid())
  priceId    String @map("price_id")
  fromStopId String @map("from_stop_id")
  toStopId   String @map("to_stop_id")
  price      Int // in cents/grosze

  priceConfig Price @relation(fields: [priceId], references: [id], onDelete: Cascade)

  @@unique([priceId, fromStopId, toStopId])
  @@map("segment_prices")
}

// ==================== Audit ====================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  companyId  String?  @map("company_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== Trip Scheduling ====================

model TripSchedule {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  routeId   String  @map("route_id")
  vehicleId String? @map("vehicle_id")
  driverId  String? @map("driver_id")

  name        String
  description String?

  // Trip times
  departureTime String @map("departure_time") // "HH:MM" format
  arrivalTime   String @map("arrival_time") // "HH:MM" format

  // Schedule type
  scheduleType String @map("schedule_type") // single, recurring

  // RRULE for recurring schedules (RFC 5545)
  rrule String?

  // Validity period
  validFrom DateTime  @map("valid_from")
  validTo   DateTime? @map("valid_to")

  // Calendar modifiers (JSON array)
  calendarModifiers Json @default("[]") @map("calendar_modifiers")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company        Company             @relation(fields: [companyId], references: [id])
  route          Route               @relation(fields: [routeId], references: [id])
  vehicle        Vehicle?            @relation(fields: [vehicleId], references: [id])
  driver         User?               @relation("ScheduleDriver", fields: [driverId], references: [id])
  exceptions     ScheduleException[]
  generatedTrips Trip[]
  stopTimes      ScheduleStopTime[]

  @@index([companyId, isActive])
  @@index([routeId])
  @@map("trip_schedules")
}

model ScheduleException {
  id         String @id @default(uuid())
  scheduleId String @map("schedule_id")

  date DateTime @db.Date
  type String // skip, modify

  // For type=modify (optional overrides)
  newDepartureTime String? @map("new_departure_time")
  newArrivalTime   String? @map("new_arrival_time")
  newVehicleId     String? @map("new_vehicle_id")
  newDriverId      String? @map("new_driver_id")

  reason    String?
  createdAt DateTime @default(now()) @map("created_at")

  schedule TripSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, date])
  @@map("schedule_exceptions")
}

// ==================== Calendars ====================

model Calendar {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  country     String // "PL", "DE", etc.
  region      String? // "mazowieckie", "slaskie"
  type        String // holidays, school_days, custom
  year        Int? // null = recurring yearly
  companyId   String?  @map("company_id") // null = system calendar, non-null = company calendar
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  entries CalendarEntry[]
  company Company?       @relation(fields: [companyId], references: [id])

  @@index([country, type])
  @@index([companyId])
  @@map("calendars")
}

model CalendarEntry {
  id         String @id @default(uuid())
  calendarId String @map("calendar_id")

  name String // "Boze Narodzenie", "Ferie zimowe"

  // Date type
  dateType String @map("date_type") // fixed, easter_relative, nth_weekday

  // For fixed: specific date
  fixedDate String? @map("fixed_date") // "MM-DD" or "YYYY-MM-DD"

  // For easter_relative: offset from Easter
  easterOffset Int? @map("easter_offset") // days, e.g. -2 (Good Friday), +1 (Easter Monday)

  // For nth_weekday: n-th weekday in month
  nthWeekday Json? @map("nth_weekday") // {"month": 11, "weekday": 4, "nth": 4} = 4th Thursday of November

  // Date range (for multi-day events like school breaks)
  startDate String? @map("start_date") // "YYYY-MM-DD"
  endDate   String? @map("end_date") // "YYYY-MM-DD"

  isRecurring Boolean @default(true) @map("is_recurring")

  calendar Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@map("calendar_entries")
}

// ==================== Company Favorites ====================

model CompanyFavoriteStop {
  id        String   @id @default(uuid())
  companyId String   @map("company_id")
  stopId    String   @map("stop_id")
  addedById String   @map("added_by_id")
  createdAt DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stop    Stop    @relation(fields: [stopId], references: [id], onDelete: Cascade)
  addedBy User    @relation("FavoriteStopAdder", fields: [addedById], references: [id])

  @@unique([companyId, stopId])
  @@map("company_favorite_stops")
}

model CompanyFavoriteRoute {
  id        String   @id @default(uuid())
  companyId String   @map("company_id")
  routeId   String   @map("route_id")
  addedById String   @map("added_by_id")
  createdAt DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  route   Route   @relation(fields: [routeId], references: [id], onDelete: Cascade)
  addedBy User    @relation("FavoriteRouteAdder", fields: [addedById], references: [id])

  @@unique([companyId, routeId])
  @@map("company_favorite_routes")
}

// ==================== Company News ====================

model CompanyNews {
  id          String    @id @default(uuid())
  companyId   String    @map("company_id")
  title       String
  content     String
  excerpt     String?
  imageUrl    String?   @map("image_url")
  publishedAt DateTime? @map("published_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdById String    @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User    @relation("NewsCreator", fields: [createdById], references: [id])

  @@index([companyId, publishedAt])
  @@map("company_news")
}

// ==================== User Favorites ====================

model UserFavoriteCompany {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  companyId String   @map("company_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("user_favorite_companies")
}

model UserFavoriteRoute {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  routeId   String   @map("route_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([userId, routeId])
  @@map("user_favorite_routes")
}

model UserFavoriteStop {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  stopId    String   @map("stop_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  stop Stop @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@unique([userId, stopId])
  @@map("user_favorite_stops")
}

// ==================== Schedule Stop Times ====================

model ScheduleStopTime {
  id            String @id @default(uuid())
  scheduleId    String @map("schedule_id")
  routeStopId   String @map("route_stop_id")
  arrivalTime   String @map("arrival_time")    // "HH:MM"
  departureTime String @map("departure_time")  // "HH:MM"

  schedule  TripSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  routeStop RouteStop    @relation(fields: [routeStopId], references: [id])

  @@unique([scheduleId, routeStopId])
  @@map("schedule_stop_times")
}
