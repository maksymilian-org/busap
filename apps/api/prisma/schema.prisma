generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Users & Companies ====================

model User {
  id                String   @id @default(uuid())
  appwriteId        String   @unique @map("appwrite_id")
  email             String   @unique
  firstName         String   @map("first_name")
  lastName          String   @map("last_name")
  phone             String?
  avatarUrl         String?  @map("avatar_url")
  preferredLanguage String   @default("pl") @map("preferred_language")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  companyUsers CompanyUser[]
  driverTrips  Trip[]        @relation("DriverTrips")
  auditLogs    AuditLog[]

  @@map("users")
}

model Company {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  logoUrl      String?  @map("logo_url")
  description  String?
  contactEmail String   @map("contact_email")
  contactPhone String?  @map("contact_phone")
  address      String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  companyUsers CompanyUser[]
  stops        Stop[]
  routes       Route[]
  vehicles     Vehicle[]
  trips        Trip[]
  prices       Price[]
  auditLogs    AuditLog[]

  @@map("companies")
}

model CompanyUser {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  companyId String   @map("company_id")
  role      String   // passenger, driver, manager, owner, superadmin
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_users")
}

// ==================== Stops ====================

model Stop {
  id        String   @id @default(uuid())
  name      String
  code      String?
  latitude  Float
  longitude Float
  address   String?
  city      String?
  country   String?
  companyId String?  @map("company_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company    Company?    @relation(fields: [companyId], references: [id])
  routeStops RouteStop[]

  @@index([companyId])
  @@index([latitude, longitude])
  @@map("stops")
}

// ==================== Routes ====================

model Route {
  id               String   @id @default(uuid())
  companyId        String   @map("company_id")
  name             String
  code             String?
  description      String?
  type             String   @default("linear") // linear, loop
  isActive         Boolean  @default(true) @map("is_active")
  currentVersionId String?  @unique @map("current_version_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  company        Company          @relation(fields: [companyId], references: [id])
  currentVersion RouteVersion?    @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions       RouteVersion[]   @relation("RouteVersions")
  exceptions     RouteException[]
  trips          Trip[]
  prices         Price[]

  @@index([companyId])
  @@map("routes")
}

model RouteVersion {
  id            String    @id @default(uuid())
  routeId       String    @map("route_id")
  versionNumber Int       @map("version_number")
  validFrom     DateTime  @map("valid_from")
  validTo       DateTime? @map("valid_to")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  route        Route       @relation("RouteVersions", fields: [routeId], references: [id], onDelete: Cascade)
  currentRoute Route?      @relation("CurrentVersion")
  stops        RouteStop[]
  trips        Trip[]

  @@unique([routeId, versionNumber])
  @@map("route_versions")
}

model RouteStop {
  id                String  @id @default(uuid())
  routeVersionId    String  @map("route_version_id")
  stopId            String  @map("stop_id")
  sequenceNumber    Int     @map("sequence_number")
  distanceFromStart Float   @default(0) @map("distance_from_start") // meters
  durationFromStart Int     @default(0) @map("duration_from_start") // minutes
  isPickup          Boolean @default(true) @map("is_pickup")
  isDropoff         Boolean @default(true) @map("is_dropoff")

  routeVersion RouteVersion   @relation(fields: [routeVersionId], references: [id], onDelete: Cascade)
  stop         Stop           @relation(fields: [stopId], references: [id])
  stopTimes    TripStopTime[]

  @@unique([routeVersionId, sequenceNumber])
  @@map("route_stops")
}

model RouteException {
  id                 String    @id @default(uuid())
  routeId            String    @map("route_id")
  type               String    // temporary, permanent
  reason             String
  affectedStopIds    String[]  @map("affected_stop_ids")
  alternativeRouteId String?   @map("alternative_route_id")
  validFrom          DateTime  @map("valid_from")
  validTo            DateTime? @map("valid_to")
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@map("route_exceptions")
}

// ==================== Vehicles ====================

model Vehicle {
  id                 String   @id @default(uuid())
  companyId          String   @map("company_id")
  registrationNumber String   @map("registration_number")
  brand              String?
  model              String?
  capacity           Int
  photoUrl           String?  @map("photo_url")
  status             String   @default("active") // active, inactive, maintenance, out_of_service
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  company   Company           @relation(fields: [companyId], references: [id])
  trips     Trip[]
  positions VehiclePosition[]

  @@unique([companyId, registrationNumber])
  @@map("vehicles")
}

model VehiclePosition {
  id        String   @id @default(uuid())
  vehicleId String   @map("vehicle_id")
  tripId    String?  @map("trip_id")
  latitude  Float
  longitude Float
  speed     Float?   // km/h
  heading   Float?   // degrees 0-360
  accuracy  Float?   // meters
  timestamp DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  trip    Trip?   @relation(fields: [tripId], references: [id])

  @@index([vehicleId, timestamp])
  @@index([tripId])
  @@map("vehicle_positions")
}

// ==================== Trips ====================

model Trip {
  id                     String    @id @default(uuid())
  companyId              String    @map("company_id")
  routeId                String    @map("route_id")
  routeVersionId         String    @map("route_version_id")
  vehicleId              String    @map("vehicle_id")
  driverId               String    @map("driver_id")
  scheduledDepartureTime DateTime  @map("scheduled_departure_time")
  scheduledArrivalTime   DateTime  @map("scheduled_arrival_time")
  actualDepartureTime    DateTime? @map("actual_departure_time")
  actualArrivalTime      DateTime? @map("actual_arrival_time")
  status                 String    @default("scheduled") // scheduled, in_progress, completed, cancelled, delayed
  notes                  String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  company      Company           @relation(fields: [companyId], references: [id])
  route        Route             @relation(fields: [routeId], references: [id])
  routeVersion RouteVersion      @relation(fields: [routeVersionId], references: [id])
  vehicle      Vehicle           @relation(fields: [vehicleId], references: [id])
  driver       User              @relation("DriverTrips", fields: [driverId], references: [id])
  stopTimes    TripStopTime[]
  positions    VehiclePosition[]

  @@index([companyId, scheduledDepartureTime])
  @@index([driverId, scheduledDepartureTime])
  @@index([status])
  @@map("trips")
}

model TripStopTime {
  id                String    @id @default(uuid())
  tripId            String    @map("trip_id")
  routeStopId       String    @map("route_stop_id")
  scheduledArrival  DateTime  @map("scheduled_arrival")
  scheduledDeparture DateTime @map("scheduled_departure")
  actualArrival     DateTime? @map("actual_arrival")
  actualDeparture   DateTime? @map("actual_departure")

  trip      Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  routeStop RouteStop @relation(fields: [routeStopId], references: [id])

  @@unique([tripId, routeStopId])
  @@map("trip_stop_times")
}

// ==================== Pricing ====================

model Price {
  id        String    @id @default(uuid())
  companyId String    @map("company_id")
  routeId   String?   @map("route_id")
  type      String    @default("flat") // flat, per_segment
  basePrice Int       @map("base_price") // in cents/grosze
  currency  String    @default("PLN")
  isActive  Boolean   @default(true) @map("is_active")
  validFrom DateTime  @map("valid_from")
  validTo   DateTime? @map("valid_to")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  company  Company        @relation(fields: [companyId], references: [id])
  route    Route?         @relation(fields: [routeId], references: [id])
  segments SegmentPrice[]

  @@index([companyId, isActive])
  @@map("prices")
}

model SegmentPrice {
  id         String @id @default(uuid())
  priceId    String @map("price_id")
  fromStopId String @map("from_stop_id")
  toStopId   String @map("to_stop_id")
  price      Int    // in cents/grosze

  priceConfig Price @relation(fields: [priceId], references: [id], onDelete: Cascade)

  @@unique([priceId, fromStopId, toStopId])
  @@map("segment_prices")
}

// ==================== Audit ====================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  companyId  String?  @map("company_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
